<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />

    <link rel="stylesheet" href="/css/identification/jquery.Jcrop.css">

</head>
<body>

<form>
    <b class="ml5">图片宽度：</b><input type="text" size="4" id="w" />
    <b class="ml5">图片高度：</b><input type="text" size="4" id="h" />
    <br>
    <b class="ml5">左上角x：</b><input type="text" size="4" id="x1" />
    <b class="ml5">左上角y:</b><input type="text" size="4" id="y1" />
    <b class="ml5">右下角x:</b><input type="text" size="4" id="x2" />
    <b class="ml5">右下角y：</b><input type="text" size="4" id="y2" />
    <br>
    <b class="ml5">选框宽度：</b><input type="text" size="4" id="showImgW" />
    <b class="ml5">选框高度：</b><input type="text" size="4" id="showImgH" />
    <br>
</form>

<input type="button" id="submit" value="确定"/>
<input type="file" id="file"/><br>

<ul>
    <li style="width: 500px;height: 500px;border: 1px red solid"><div id="img"></div></li>
    <li><canvas id="cut" width="200" height="220" style="border: 1px coral solid"></canvas></li>
    <li><img id="finalImg" src="" alt=""></li>
</ul>

<script src="/jquery/jquery-3.4.1.js"></script>
<script src="/jquery/jquery.Jcrop.js"></script>

<script>
    $(function() {
        var imgUrl;
        var preImgWidth = $("#cut").css("width");
        var preImgheight = $("#cut").css("height");
        $("#preImgW").val(preImgWidth)
        $("#preImgH").val(preImgheight)
        $('input[type=file]').change(function() {
            var file = this.files[0];
            var reader = new FileReader();
            reader.onload = function() {
                // 通过 reader.result 来访问生成的 DataURL
                var url = reader.result;
                setImageURL(url);
            };
            reader.readAsDataURL(file);
        });

        var image = new Image();

        function setImageURL(url) {
            image.src = url;
            image.id = "target";
            $("#img").append(image);

            var cut = document.getElementById("cut");
            var ctx = cut.getContext("2d");

            image.onload = function() {
                $('#w').val($('#target').css('width'));
                $('#h').val($('#target').css('height'));
                $('#target').Jcrop({
                    boxWidth: 500,
                    boxHeight: 500,
                    onChange: updatePreview,
                    onSelect: updatePreview,
                });
                //裁剪过程中，每改变裁剪大小执行该函数
                function updatePreview(c) {

                    console.log("===========================")
                    $("#x1").val(c.x)//剪切框左上角x坐标
                    $("#y1").val(c.y)//剪切框左上角y坐标
                    $("#x2").val(c.x2)//剪切框右上角x坐标
                    $("#y2").val(c.y2)//剪切框右上角x坐标

                    if(parseInt(c.w) > 0) {
                        $("#showImgW").val(c.w);
                        $("#showImgH").val(c.h);
                        ctx.drawImage(image, c.x, c.y, c.w, c.h, 0, 0, parseInt(preImgWidth), parseInt(preImgheight));
                        imgUrl = cut.toDataURL("image/png");//canvas画布转换为base64
                        console.log(c.x, c.y, c.w, c.h);
                    }
                };
            }
        }

        $("#submit").click(function(){
            $("#finalImg").attr("src",imgUrl)
        })
    })

    //将base64转换为文件
    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

    //上传图片
    $("#upload").click(function () {
        var formData = new FormData();
        var id = 6;
        var imgFileUrl = $("#finalImg").attr("src");//base64

        formData.append("id",id);
        formData.append("multipartFile",dataURLtoFile(imgFileUrl,"img.png"));
        $.ajax({
            url:"/ssm/book/updateBook.do",
            type : 'post',
            data : formData,
            cache: false,   //上传文件无需缓存
            processData: false,   // 用于对参数进行序列化处理，这里必须设为false
            contentType:false,
            success:function (resultData) {
                if(resultData.code == 0){
                    window.location.href ="http://localhost:8080/ssm/bookinfo.html";
                    alert("更新成功")

                }else {
                    alert("更新失败");
                }
            }
        })
    })

</script>
</body>
</html>